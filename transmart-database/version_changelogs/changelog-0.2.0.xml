<?xml version="1.0" encoding="UTF-8"?> 
<databaseChangeLog 
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd"> 

  <changeSet author="mmcduffie" id="1">
  <comment>Dropping this table to recreate it as a global temp table.</comment>
	<dropTable cascadeConstraints="true"
            schemaName="I2B2DEMODATA"
            tableName="QUERY_GLOBAL_TEMP" />
  </changeSet>

  <changeSet author="mmcduffie" id="2">
  <comment>This table needs to be created as a global temp table.</comment>
	<sql>
CREATE GLOBAL TEMPORARY TABLE "I2B2DEMODATA"."QUERY_GLOBAL_TEMP" 
   (	"ENCOUNTER_NUM" NUMBER(22,0), 
	"PATIENT_NUM" NUMBER(22,0), 
	"INSTANCE_NUM" NUMBER(18,0), 
	"CONCEPT_CD" VARCHAR2(50 BYTE), 
	"START_DATE" DATE, 
	"PROVIDER_ID" VARCHAR2(50 BYTE), 
	"PANEL_COUNT" NUMBER(5,0), 
	"FACT_COUNT" NUMBER(22,0), 
	"FACT_PANELS" NUMBER(5,0)
   ) ON COMMIT PRESERVE ROWS ;
	</sql>
  </changeSet>

  <changeSet author="mmcduffie" id="3">
  <comment>Dropping this table to recreate it as a global temp table.</comment>
        <dropTable cascadeConstraints="true"
            schemaName="I2B2DEMODATA"
            tableName="MASTER_QUERY_GLOBAL_TEMP" />
  </changeSet>

  <changeSet author="mmcduffie" id="4">
  <comment>This table needs to be created as a global temp table.</comment>
        <sql>
  CREATE GLOBAL TEMPORARY TABLE "I2B2DEMODATA"."MASTER_QUERY_GLOBAL_TEMP" 
   (	"ENCOUNTER_NUM" NUMBER(22,0), 
	"PATIENT_NUM" NUMBER(22,0), 
	"INSTANCE_NUM" NUMBER(18,0), 
	"CONCEPT_CD" VARCHAR2(50 BYTE), 
	"START_DATE" DATE, 
	"PROVIDER_ID" VARCHAR2(50 BYTE), 
	"MASTER_ID" VARCHAR2(50 BYTE), 
	"LEVEL_NO" NUMBER(5,0)
   ) ON COMMIT PRESERVE ROWS ;
        </sql>
  </changeSet>

  <changeSet author="mmcduffie" id="5">
  <comment>Dropping this table to recreate it as a global temp table.</comment>
        <dropTable cascadeConstraints="true"
            schemaName="I2B2DEMODATA"
            tableName="GLOBAL_TEMP_FACT_PARAM_TABLE" />
  </changeSet>

  <changeSet author="mmcduffie" id="6">
  <comment>This table needs to be created as a global temp table.</comment>
        <sql>
  CREATE GLOBAL TEMPORARY TABLE "I2B2DEMODATA"."GLOBAL_TEMP_FACT_PARAM_TABLE" 
   (	"SET_INDEX" NUMBER(*,0), 
	"CHAR_PARAM1" VARCHAR2(500 BYTE), 
	"CHAR_PARAM2" VARCHAR2(500 BYTE), 
	"NUM_PARAM1" NUMBER(*,0), 
	"NUM_PARAM2" NUMBER(*,0)
   ) ON COMMIT PRESERVE ROWS ;
        </sql>
  </changeSet>

<changeSet author="mmcduffie" id="7">
  <comment>Dropping this table to recreate it as a global temp table.</comment>
        <dropTable cascadeConstraints="true"
            schemaName="I2B2DEMODATA"
            tableName="GLOBAL_TEMP_PARAM_TABLE" />
  </changeSet>

  <changeSet author="mmcduffie" id="8">
  <comment>This table needs to be created as a global temp table.</comment>
        <sql>
  CREATE GLOBAL TEMPORARY TABLE "I2B2DEMODATA"."GLOBAL_TEMP_PARAM_TABLE" 
   (	"SET_INDEX" NUMBER(*,0), 
	"CHAR_PARAM1" VARCHAR2(500 BYTE), 
	"CHAR_PARAM2" VARCHAR2(500 BYTE), 
	"NUM_PARAM1" NUMBER(*,0), 
	"NUM_PARAM2" NUMBER(*,0)
   ) ON COMMIT PRESERVE ROWS ;
        </sql>
  </changeSet>

<changeSet author="mmcduffie" id="9">
  <comment>Dropping this table to recreate it as a global temp table.</comment>
        <dropTable cascadeConstraints="true"
            schemaName="I2B2DEMODATA"
            tableName="DX" />
  </changeSet>

  <changeSet author="mmcduffie" id="10">
  <comment>This table needs to be created as a global temp table.</comment>
        <sql>
 CREATE GLOBAL TEMPORARY TABLE "I2B2DEMODATA"."DX" 
   (	"ENCOUNTER_NUM" NUMBER(22,0), 
	"PATIENT_NUM" NUMBER(22,0)
   ) ON COMMIT PRESERVE ROWS ;

        </sql>
  </changeSet>

  <changeSet author="mmcduffie" id="11">
  <comment>Adding more privs for TM_CZ</comment>
  <sql>
	GRANT DROP ANY PROCEDURE TO TM_CZ;
	GRANT CREATE ANY PROCEDURE TO TM_CZ;
  </sql>
  </changeSet>

  <changeSet author="mmcduffie" id="12">
  <comment>Missing Index</comment>
  <sql>
	GRANT CTXAPP TO i2b2metadata;
	GRANT CTXAPP TO i2b2demodata;
  </sql>
  </changeSet>

  <changeSet author="mmcduffie" id="13">
  <comment>These permissions need to be applied after the tables are created.</comment>
  <sql>
        GRANT SELECT ON I2B2DEMODATA.CONCEPT_COUNTS TO TM_CZ;
        GRANT SELECT ON I2B2DEMODATA.CONCEPT_DIMENSION TO TM_CZ;
        GRANT SELECT ON I2B2DEMODATA.CONCEPTS_FOLDERS_PATIENTS TO TM_CZ;
        GRANT SELECT ON I2B2METADATA.I2B2 TO TM_CZ;
        GRANT SELECT ON I2B2DEMODATA.PATIENT_DIMENSION TO TM_CZ;
        GRANT SELECT ON I2B2DEMODATA.PATIENT_MAPPING TO TM_CZ;
        GRANT SELECT ON I2B2DEMODATA.PATIENT_TRIAL TO TM_CZ;
  </sql>
  </changeSet>

  <changeSet author="mmcduffie" id="14" failOnError="false">
  <comment>Missing Index</comment>
  <sql>
          CREATE INDEX "I2B2DEMODATA"."CD_CONCEPT_PATH_TEXT" ON "I2B2DEMODATA"."CONCEPT_DIMENSION" ("CONCEPT_PATH") INDEXTYPE IS "CTXSYS"."CONTEXT" ;
  </sql>
  </changeSet>

  <changeSet author="mmcduffie" id="15" failOnError="false">
  <comment>Missing Index</comment>
  <sql>
 	CREATE INDEX "I2B2METADATA"."I2B2_FULLNAME_TEXT" ON "I2B2METADATA"."I2B2" ("C_FULLNAME") INDEXTYPE IS "CTXSYS"."CONTEXT" ;
  </sql>
  </changeSet>

</databaseChangeLog>
