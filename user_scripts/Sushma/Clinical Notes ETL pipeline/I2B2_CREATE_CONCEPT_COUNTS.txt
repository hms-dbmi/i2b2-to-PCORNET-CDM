create or replace PROCEDURE   I2B2_CREATE_CONCEPT_COUNTS AS
path varchar2(1000);
pat_num number;
enc_num number;
i number;
y number;
BEGIN

  FOR rec IN (SELECT distinct encounter_num,patient_num,C_FULLNAME FROM i2b2demodata.concept_counts_temp)

  LOOP

  i:=i+1;

   DBMS_OUTPUT.ENABLE(1000000);

  path := rec.C_FULLNAME;

  pat_num := rec.PATIENT_NUM;
  
  enc_num := rec.encounter_num;
  
    INSERT/*+ APPEND NOLOGGING */ INTO i2b2demodata.concept_counts_temp2 values(path,pat_num,enc_num);

  WHILE path != '\'

  LOOP

  y:=y+1;

  path :=    SUBSTR(path,1,INSTR(path,'\',-2,1));

  INSERT/*+ APPEND NOLOGGING */ INTO i2b2demodata.concept_counts_temp2 values(path,pat_num,enc_num);

  END LOOP;

  END LOOP;

/* Create indexes  */

  execute immediate('CREATE INDEX  i2b2demodata.LEAF_NODE_IDX ON i2b2demodata.concept_counts_temp2 (c_fullname)');

  execute immediate('CREATE INDEX  i2b2demodata.PATIENTNUM_IDX ON i2b2demodata.concept_counts_temp2 (patient_num)');
  
    execute immediate('CREATE INDEX  i2b2demodata.ENCNUM_IDX ON i2b2demodata.concept_counts_temp2 (encounter_num)');

FOR rec IN (SELECT * FROM I2B2METADATA.I2B2_TEMP)
 LOOP
  path := rec.C_FULLNAME;
 
insert /*+ APPEND NOLOGGING */  INTO "I2B2DEMODATA"."NODE_METADATA"
 select path AS concept_path,SUBSTR(path,1,INSTR(path,'\',-2,1)) as parent_concept_path,count(distinct patient_num) as value,'PATIENT_COUNT' as type,6 as node_metadata_id from i2b2demodata.concept_counts_temp2  where c_fullname=path;
 commit;
 insert /*+ APPEND NOLOGGING */  INTO "I2B2DEMODATA"."NODE_METADATA"
  select path AS concept_path,SUBSTR(path,1,INSTR(path,'\',-2,1)) as parent_concept_path,count(distinct encounter_num) as value,'DOCUMENT_COUNT' as type,7 as node_metadata_id from i2b2demodata.concept_counts_temp2  where c_fullname=path;
 commit;
 END LOOP;
 

FOR rec IN (SELECT * FROM I2B2METADATA.I2B2_LEAVES)
 LOOP
  path := rec.C_FULLNAME;
 
insert /*+ APPEND NOLOGGING */ INTO "I2B2DEMODATA"."NODE_METADATA"
 select path AS concept_path,SUBSTR(path,1,INSTR(path,'\',-2,1)) as parent_concept_path,count(distinct patient_num) as value,'Concept_Count' as type,5 as node_metadata_id from i2b2demodata.concept_counts_temp2  where c_fullname=path;
 commit;
 
  NULL;
END I2B2_CREATE_CONCEPT_COUNTS;